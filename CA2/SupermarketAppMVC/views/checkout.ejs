<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Checkout</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    body {
      background-color: #f8f9fa;
      color: #343a40;
    }

    /* Navbar */
    .navbar {
      background-color: #28a745;
    }
    .navbar .nav-link,
    .navbar .navbar-brand {
      color: #ffffff;
      font-weight: 500;
    }
    .navbar .nav-link:hover {
      color: #d4edda;
    }

    /* Card */
    .card {
      border-radius: 15px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    /* Buttons */
    .btn-primary {
      background-color: #28a745;
      border-color: #28a745;
    }
    .btn-primary:hover {
      background-color: #218838;
      border-color: #218838;
    }

    a {
      text-decoration: none;
      color: #28a745;
    }
    a:hover {
      color: #218838;
    }
  </style>
</head>

<body>
  <%- include('partials/header') %>
  <!-- MAIN CONTENT -->
  <div class="container mt-4">

    <h2>Checkout</h2>

    <% if (messages && messages.length) { %>
      <div class="alert alert-success">
        <% messages.forEach(function(m){ %>
          <div><%= m %></div>
        <% }) %>
      </div>
    <% } %>

    <% if (errors && errors.length) { %>
      <div class="alert alert-danger">
        <% errors.forEach(function(e){ %>
          <div><%= e %></div>
        <% }) %>
      </div>
    <% } %>

    <div class="card p-4 mt-3">

      <form action="/checkout" method="POST">

        <!-- DELIVERY OPTIONS -->
        <h5 class="mt-3">Delivery Options</h5>
        <div class="mb-3">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="deliveryOption" id="doorstep" value="doorstep" checked>
            <label class="form-check-label" for="doorstep">Doorstep delivery (additional $5.00)</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="deliveryOption" id="selfpickup" value="self-pickup">
            <label class="form-check-label" for="selfpickup">Self-pickup (Free)</label>
          </div>
        </div>

        <!-- ADDRESS SECTION - shown only for doorstep delivery; appears under delivery options -->
        <div id="address-section">
          <h4 class="mb-3">Delivery Address</h4>
          <div class="mb-3" id="address-group">
            <label for="address" class="form-label">Address</label>
            <textarea name="address"
                      id="address"
                      class="form-control"
                      rows="3"
                      required><%= user && user.address ? user.address : '' %></textarea>
          </div>
        </div>

        <!-- ORDER SUMMARY -->
        <h5 class="mt-3">Order Summary</h5>

        <ul class="list-group mb-3">
          <% let total = 0; %>

          <% cart.forEach(function(item){ %>
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <strong><%= item.productName %></strong><br>
                <small>Qty: <%= item.quantity %> Ã— $<%= item.price.toFixed(2) %></small>
              </div>
              <span>$<%= (item.quantity * item.price).toFixed(2) %></span>
            </li>
            <% total += item.quantity * item.price; %>
          <% }) %>

          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>Delivery Fee</div>
            <span id="delivery-fee-display">$0.00</span>
          </li>

          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div><strong>Final Total</strong></div>
            <strong id="final-total-display">$<%= total.toFixed(2) %></strong>
          </li>
        </ul>

        <!-- PAYMENT METHOD -->
        <h5 class="mt-3">Payment Method</h5>
        <div class="mb-3">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="paymentMethod" id="applepay" value="Apple Pay" checked>
            <label class="form-check-label" for="applepay">Apple Pay</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="paymentMethod" id="paynow" value="PayNow">
            <label class="form-check-label" for="paynow">PayNow</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="paymentMethod" id="card" value="Debit/Credit Card">
            <label class="form-check-label" for="card">Debit / Credit Card</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="paymentMethod" id="netsqr" value="netsqr">
            <label class="form-check-label" for="netsqr">NETS QR</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="paymentMethod" id="paypalRadio" value="PayPal">
            <label class="form-check-label" for="paypalRadio">PayPal</label>
          </div>
        </div>

        <!-- PayPal button container (shown when PayPal is selected) -->
        <div id="paypal-button-container" style="display:none;" class="mb-3"></div>

        <!-- Hidden inputs to submit computed values -->
        <input type="hidden" name="deliveryType" id="deliveryTypeInput" value="doorstep">
        <input type="hidden" name="deliveryFee" id="deliveryFeeInput" value="5.00">
        <input type="hidden" name="finalTotal" id="finalTotalInput" value="<%= total.toFixed(2) %>">
        <input type="hidden" name="cartTotal" id="cartTotalInput" value="<%= total.toFixed(2) %>">

        <!-- BUTTONS -->
        <div class="mt-3 text-end">
          <a href="/cart" class="btn btn-secondary me-2">Back to Cart</a>
          <button type="submit" id="placeOrderBtn" class="btn btn-primary">Place Order</button>
        </div>

      </form>

      <script>
        (function(){
          // subtotal from server
          var subtotal = parseFloat('<%= total.toFixed(2) %>');
          var deliveryFee = 5.00;

          var doorstepRadio = document.getElementById('doorstep');
          var selfpickupRadio = document.getElementById('selfpickup');
          var deliveryFeeDisplay = document.getElementById('delivery-fee-display');
          var finalTotalDisplay = document.getElementById('final-total-display');
          var deliveryTypeInput = document.getElementById('deliveryTypeInput');
          var deliveryFeeInput = document.getElementById('deliveryFeeInput');
          var finalTotalInput = document.getElementById('finalTotalInput');
          var addressSection = document.getElementById('address-section');
          var addressTextarea = document.getElementById('address');

          function updateTotals(){
            var fee = doorstepRadio.checked ? deliveryFee : 0.00;
            var finalTotal = subtotal + fee;
            deliveryFeeDisplay.textContent = '$' + fee.toFixed(2);
            finalTotalDisplay.textContent = '$' + finalTotal.toFixed(2);
            deliveryTypeInput.value = doorstepRadio.checked ? 'doorstep' : 'self-pickup';
            deliveryFeeInput.value = fee.toFixed(2);
            finalTotalInput.value = finalTotal.toFixed(2);
            // Show/hide address section and toggle required attribute
            if (doorstepRadio.checked) {
              if (addressSection) addressSection.style.display = 'block';
              if (addressTextarea) addressTextarea.required = true;
            } else {
              if (addressSection) addressSection.style.display = 'none';
              if (addressTextarea) {
                addressTextarea.required = false;
                // optional: clear address when hidden
                // addressTextarea.value = '';
              }
            }
          }

          doorstepRadio.addEventListener('change', updateTotals);
          selfpickupRadio.addEventListener('change', updateTotals);

          // initialize on load
          updateTotals();
        })();
      </script>
      <script>
        (function(){
          // Toggle PayPal buttons when PayPal payment selected
          const paypalRadio = document.getElementById('paypalRadio');
          const placeOrderBtn = document.getElementById('placeOrderBtn');
          const paypalContainer = document.getElementById('paypal-button-container');

          function showPaypal(show) {
            if (show) {
              paypalContainer.style.display = 'block';
              placeOrderBtn.style.display = 'none';
            } else {
              paypalContainer.style.display = 'none';
              placeOrderBtn.style.display = 'inline-block';
            }
          }

          // initialize state
          showPaypal(false);

          // attach change listeners to payment radios
          const radios = document.querySelectorAll('input[name="paymentMethod"]');
          radios.forEach(r => r.addEventListener('change', function(){
            showPaypal(this.id === 'paypalRadio');
            // If NETS QR selected, ensure default form action will send to nets route
            if (this.id === 'netsqr') {
              // keep place order visible; form will be redirected to nets handler on submit
              placeOrderBtn.style.display = 'inline-block';
            }
          }));

          // Intercept form submit: if NETS QR selected, change action to nets endpoint
          const checkoutForm = document.querySelector('form[action="/checkout"]');
          if (checkoutForm) {
            checkoutForm.addEventListener('submit', function(e){
              const selected = document.querySelector('input[name="paymentMethod"]:checked');
              // keep cartTotal in sync with final total for NETS
              const cartTotalInput = document.getElementById('cartTotalInput');
              const finalTotalInputEl = document.getElementById('finalTotalInput');
              if (cartTotalInput && finalTotalInputEl) {
                cartTotalInput.value = finalTotalInputEl.value;
              }
              if (selected && selected.id === 'netsqr') {
                // change form target to NETS QR request handler which will render QR
                this.action = '/nets-qr/request';
                // ensure method is POST (already is)
              } else {
                // restore default
                this.action = '/checkout';
              }
            });
          }

          // load PayPal SDK script dynamically using server-side client id
          const PAYPAL_CLIENT_ID = '<%= PAYPAL_CLIENT_ID %>' || '';
          if (PAYPAL_CLIENT_ID) {
            const s = document.createElement('script');
            s.src = `https://www.paypal.com/sdk/js?client-id=${PAYPAL_CLIENT_ID}&currency=SGD`;
            s.onload = function() {
              // render buttons
              if (window.paypal) {
                paypal.Buttons({
                  createOrder: function(data, actions) {
                    // ask server to create order (server computes total) using API route
                    const amount = document.getElementById('finalTotalInput').value || '0';
                    const deliveryFee = document.getElementById('deliveryFeeInput').value || '0';
                    return fetch('/api/paypal/create-order', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ amount, deliveryFee }) }).then(res => res.json()).then(order => order.id);
                  },
                  onApprove: function(data, actions) {
                    // capture on server and then redirect to invoice
                    const payload = { orderID: data.orderID, address: document.getElementById('address').value || '', deliveryType: document.getElementById('deliveryTypeInput').value || 'doorstep', deliveryFee: document.getElementById('deliveryFeeInput').value || '0' };
                    return fetch('/api/paypal/capture-order', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }).then(res => res.json()).then(resp => {
                      if (resp && resp.success && resp.invoiceUrl) {
                        // Append a flag so the invoice page can show a success message
                        const sep = resp.invoiceUrl.indexOf('?') === -1 ? '?' : '&';
                        window.location = resp.invoiceUrl + sep + 'paid=paypal';
                      } else {
                        alert('Payment succeeded but order creation failed.');
                        console.error('Capture response', resp);
                      }
                    });
                  },
                  onError: function(err) { console.error('PayPal Buttons error', err); }
                }).render('#paypal-button-container');
              }
            };
            document.body.appendChild(s);
          }
        })();
      </script>
    </div>

  </div>

</body>
</html>